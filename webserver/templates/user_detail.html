<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户详情</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .user-detail {
            margin-top: 20px;
        }
        .user-detail p {
            margin: 10px 0;
        }
        .user-detail strong {
            font-weight: bold;
        }
        .actions {
            margin-top: 20px;
        }
        .actions button {
            margin-right: 10px;
        }
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定位置 */
            z-index: 1; /* 确保在最上层 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0); /* 背景色 */
            background-color: rgba(0,0,0,0.4); /* 带透明度的背景色 */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 垂直居中 */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>用户详情</h1>
    <div class="user-detail">
        <p><strong>ID:</strong> {{ user.id }}</p>
        <p><strong>姓名:</strong> {{ user.name }}</p>
        <p><strong>身份证号码:</strong> {{ user.identity_card }}</p>
        <p><strong>住院号:</strong> {{ user.admission_no }}</p>
        <p><strong>性别:</strong> {{ user.gender }}</p>
        <p><strong>年龄:</strong> {{ user.age }}</p>
        <p><strong>生育史:</strong> {{ user.fertility_history }}</p>
        <p><strong>教育程度:</strong> {{ user.education_level }}</p>
        <p><strong>职业:</strong> {{ user.occupation }}</p>
        <p><strong>诊断:</strong> {{ user.diagnosis }}</p>
        <p><strong>合并疾病:</strong> {{ user.comorbidity }}</p>
        <p><strong>治疗方式:</strong> {{ user.therapeutic_modality }}</p>
        <p><strong>医疗费用承担方式:</strong> {{ user.methods_of_medical_cost_coverage }}</p>
        <p><strong>婚姻状况:</strong> {{ user.marital_status }}</p>
        <p><strong>电话:</strong> {{ user.phone }}</p>
        <p><strong>紧急联系人:</strong> {{ user.emergency_contact }}</p>
        <p><strong>紧急联系人电话:</strong> {{ user.emergency_contact_phone }}</p>
        <p><strong>家庭住址:</strong> {{ user.address }}</p>
        <p><strong>农业户口:</strong> {{ user.agricultural_indicator }}</p>
        <p><strong>创建时间:</strong> {{ user.create_time }}</p>
        <p><strong>更新时间:</strong> {{ user.update_time }}</p>
    </div>
    <div class="actions">
        <button onclick="openUpdateModal({{ user.id }})">更新用户</button>
        <button onclick="deleteUser({{ user.id }})">删除用户</button>
        <button onclick="openPsychologicalModal({{ user.id }})">查看心理量表得分</button>
    </div>

    <!-- 更新用户模态框 -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUpdateModal()">&times;</span>
            <h2>更新用户</h2>
            <form id="updateUserForm">
                <input type="hidden" id="updateUserId" value="{{ user.id }}">
                <label for="updateName">姓名:</label>
                <input type="text" id="updateName" name="name" value="{{ user.name }}" required>
                <br>
                <label for="updateIdentityCard">身份证号:</label>
                <input type="text" id="updateIdentityCard" name="identity_card" value="{{ user.identity_card }}" required>
                <br>
                <label for="updateAdmissionNo">住院号:</label>
                <input type="text" id="updateAdmissionNo" name="admission_no" value="{{ user.admission_no }}" required>
                <br>
                <label for="updateGender">性别:</label>
                <select id="updateGender" name="gender" required>
                    <option value="Male" {% if user.gender == 'Male' %}selected{% endif %}>男</option>
                    <option value="Female" {% if user.gender == 'Female' %}selected{% endif %}>女</option>
                </select>
                <br>
                <label for="updateAge">年龄:</label>
                <input type="number" id="updateAge" name="age" value="{{ user.age }}" required>
                <br>
                <label for="updateFertilityHistory">生育史:</label>
                <input type="text" id="updateFertilityHistory" name="fertility_history" value="{{ user.fertility_history }}" required>
                <br>
                <label for="updateEducationLevel">教育水平:</label>
                <select id="updateEducationLevel" name="education_level" required>
                    <option value="Primary" {% if user.education_level == 'Primary' %}selected{% endif %}>小学</option>
                    <option value="Secondary" {% if user.education_level == 'Secondary' %}selected{% endif %}>中学</option>
                    <option value="Higher" {% if user.education_level == 'Higher' %}selected{% endif %}>大学及以上</option>
                </select>
                <br>
                <label for="updateOccupation">职业:</label>
                <input type="text" id="updateOccupation" name="occupation" value="{{ user.occupation }}" required>
                <br>
                <label for="updateDiagnosis">诊断:</label>
                <input type="text" id="updateDiagnosis" name="diagnosis" value="{{ user.diagnosis }}" required>
                <br>
                <label for="updateComorbidity">合并症:</label>
                <input type="text" id="updateComorbidity" name="comorbidity" value="{{ user.comorbidity }}" required>
                <br>
                <label for="updateTherapeuticModality">治疗方式:</label>
                <input type="text" id="updateTherapeuticModality" name="therapeutic_modality" value="{{ user.therapeutic_modality }}" required>
                <br>
                <label for="methods_of_medical_cost_coverage">医疗费用承担方式:</label>
                <input type="text" id="methods_of_medical_cost_coverage" name="methods_of_medical_cost_coverage" value="{{ user.methods_of_medical_cost_coverage }}"required>
                <br>
                <label for="updateMaritalStatus">婚姻状况:</label>
                <select id="updateMaritalStatus" name="marital_status" required>
                    <option value="Single" {% if user.marital_status == 'Single' %}selected{% endif %}>单身</option>
                    <option value="Married" {% if user.marital_status == 'Married' %}selected{% endif %}>已婚</option>
                    <option value="Divorced" {% if user.marital_status == 'Divorced' %}selected{% endif %}>离异</option>
                </select>
                <br>
                <label for="updatePhone">电话:</label>
                <input type="text" id="updatePhone" name="phone" value="{{ user.phone }}" required>
                <br>
                <label for="updateEmergencyContact">紧急联系人:</label>
                <input type="text" id="updateEmergencyContact" name="emergency_contact" value="{{ user.emergency_contact }}" required>
                <br>
                <label for="updateEmergencyContactPhone">紧急联系人电话:</label>
                <input type="text" id="updateEmergencyContactPhone" name="emergency_contact_phone" value="{{ user.emergency_contact_phone }}" required>
                <br>
                <label for="updateAddress">地址:</label>
                <input type="text" id="updateAddress" name="address" value="{{ user.address }}" required>
                <br>
                <label for="updateAgriculturalIndicator">农村户口:</label>
                <select id="updateAgriculturalIndicator" name="agricultural_indicator" required>
                    <option value="True" {% if user.agricultural_indicator %}selected{% endif %}>是</option>
                    <option value="False" {% if not user.agricultural_indicator %}selected{% endif %}>否</option>
                </select>
                <br>
                <button type="button" onclick="submitUpdateForm()">提交</button>
            </form>
        </div>
    </div>

    <!-- 心理量表得分模态框 -->
    <div id="psychologicalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePsychologicalModal()">&times;</span>
            <h2>心理量表得分</h2>
            <div id="psychologicalScores">
                {% for record in psychological_records %}
                    <p><strong>心率:</strong> {{ record.pulse }}</p>
                    <p><strong>呼吸频率:</strong> {{ record.respiration_rate }}</p>
                    <p><strong>血压:</strong> {{ record.blood_pressure }}</p>
                    <p><strong>应激感受量表评分:</strong> {{ record.pss_score }}</p>
                    <p><strong>广泛性焦虑量表评分:</strong> {{ record.gad_score }}</p>
                    <p><strong>宾州担忧问卷评分:</strong> {{ record.pswq_score }}</p>
                    <p><strong>患者健康问卷抑郁量表评分:</strong> {{ record.phq_score }}</p>
                    <p><strong>反刍思维量表评分:</strong> {{ record.rrs_score }}</p>
                    <p><strong>前瞻回溯记忆问卷评分:</strong> {{ record.prmq_score }}</p>
                    <p><strong>生命质量核心量表评分:</strong> {{ record.qlq_score }}</p>
                    <p><strong>匹兹堡睡眠质量指数评分:</strong> {{ record.psqi_score }}</p>
                    <hr>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        function openUpdateModal(userId) {
            // 显示模态框
            document.getElementById('updateModal').style.display = 'block';
        }

        function closeUpdateModal() {
            // 隐藏模态框
            document.getElementById('updateModal').style.display = 'none';
        }

        function deleteUser(userId) {
            if (confirm('确定要删除该用户吗？')) {
                fetch(`/api/test/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('用户删除成功');
                        window.location.href = '/api/test/users'; // 跳转到用户列表页面
                    } else {
                        alert('用户删除失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求失败，请稍后重试');
                });
            }
        }

        function submitUpdateForm() {
            // 获取表单数据
            var formData = {
                name: document.getElementById('updateName').value,
                identity_card: document.getElementById('updateIdentityCard').value,
                admission_no: document.getElementById('updateAdmissionNo').value,
                gender: document.getElementById('updateGender').value,
                age: document.getElementById('updateAge').value,
                fertility_history: document.getElementById('updateFertilityHistory').value,
                education_level: document.getElementById('updateEducationLevel').value,
                occupation: document.getElementById('updateOccupation').value,
                diagnosis: document.getElementById('updateDiagnosis').value,
                comorbidity: document.getElementById('updateComorbidity').value,
                therapeutic_modality: document.getElementById('updateTherapeuticModality').value,
                methods_of_medical_cost_coverage: document.getElementById('methods_of_medical_cost_coverage').value,
                marital_status: document.getElementById('updateMaritalStatus').value,
                phone: document.getElementById('updatePhone').value,
                emergency_contact: document.getElementById('updateEmergencyContact').value,
                emergency_contact_phone: document.getElementById('updateEmergencyContactPhone').value,
                address: document.getElementById('updateAddress').value,
                agricultural_indicator: document.getElementById('updateAgriculturalIndicator').value === 'True'
            };

            var userId = document.getElementById('updateUserId').value;

            // 发送数据到服务器
            fetch(`/api/test/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('用户更新成功');
                    closeUpdateModal(); // 关闭模态框
                    window.location.reload(); // 刷新页面
                } else {
                    alert('用户更新失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('请求失败，请稍后重试');
            });
        }

        function openPsychologicalModal(userId) {
            // 显示模态框
            document.getElementById('psychologicalModal').style.display = 'block';
        }

        function closePsychologicalModal() {
            // 隐藏模态框
            document.getElementById('psychologicalModal').style.display = 'none';
        }

        // 点击模态框外部区域关闭模态框
        window.onclick = function(event) {
            var modal = document.getElementById('updateModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>